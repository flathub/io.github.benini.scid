app-id: io.github.benini.scid
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: scid

finish-args:
  - --filesystem=home        # for accessing files in the user's home folder
  - --share=network          # access the network
  - --socket=x11             # show windows with x11
  - --share=ipc              # share IPC namespace with the host (necessary for X11)
  - --device=dri             # OpenGL rendering
  - --socket=pulseaudio      # play sound with PulseAudio

modules:
  - name: stockfish # Stockfish engine, put into /app/engines
    subdir: src
    buildsystem: simple
    build-options:
      arch:
        x86_64:
          env:
            ARCH: x86-64
        aarch64:
          env:
            ARCH: armv8
    build-commands:
      - make -j $FLATPAK_BUILDER_N_JOBS build
      - make install BINDIR=/app/engines
    sources:
      - type: archive
        url: https://github.com/official-stockfish/Stockfish/archive/sf_17.1.tar.gz
        sha256: 0cfd9396438798cc68f5c0d5fa0bb458bb8ffff7de06add841aaeace86bec1f1
        x-checker-data:
          type: anitya
          project-id: 5750
          url-template: https://github.com/official-stockfish/Stockfish/archive/sf_$version.tar.gz
      - type: file
        dest: src
        url: https://tests.stockfishchess.org/api/nn/nn-1c0000000000.nnue
        sha256: 1c0000000000a67d629999d932d0c373f7450ce43cd12d0562868f4eaf9ae2ad
      - type: file
        dest: src
        url: https://tests.stockfishchess.org/api/nn/nn-37f18f62d772.nnue
        sha256: 37f18f62d772f3107e1d6aaca3898c130c3c86f2ab63e6555fbbca20635a899d

  - name: eigen # library for linear algebra, used for lc0
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.gz
        sha256: 8586084f71f9bde545ee7fa6d00288b264a2b7ac3607b974e54d13e7162c1c72

  - name: openblas # Basic Linear Algebra Subprograms library, used for lc0
    no-autogen: true
    make-args:
      - DYNAMIC_ARCH=1
      - FC=gfortran
      - NO_LAPACKE=1
      - USE_OPENMP=0
    make-install-args:
      - PREFIX=/app
    cleanup:
      - /bin
      - /include
      - /lib/cmake
      - /lib/*.a
      - /lib/*.la
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: archive
        url: https://github.com/OpenMathLib/OpenBLAS/archive/v0.3.30.tar.gz
        sha512: c726ced2d3e6ebd3ddcd0b13c255bb43fae8c12d2aec15e9ef992b0bc7099996c02cd284ccaaa7b5fac3f23f280b098063dd60f521d97a68dc183ab192fcccdb
        x-checker-data:
          type: anitya
          project-id: 2540
          url-template: https://github.com/OpenMathLib/OpenBLAS/archive/v$version.tar.gz

  - name: lc0 # Lc0 engine, put into /app/engines/lc0
    buildsystem: meson
    config-opts:
      - -Dopenblas=true
      - -Dopenblas_libdirs=/app/lib
      - -Dgtest=false
      - -Db_lto=true
      - -Dopencl=false
    post-install:
      - mkdir -p /app/engines/lc0
      - mv /app/bin/lc0 /app/engines/lc0/
    sources:
      - type: git
        url: https://github.com/LeelaChessZero/lc0.git
        tag: v0.31.2
        commit: 8ba8aa426460bbeda452754ff7d6a9bb60bb0e54

  - name: nn # Recommended medium size network for GPU/CPU usage (see https://lczero.org/play/networks/bestnets/)
    buildsystem: simple
    build-commands:
      - mkdir -p /app/engines/lc0
      - gzip -d nn.pb.gz
      - mv nn.pb /app/engines/lc0/
    sources:
      - type: file
        dest-filename: nn.pb.gz
        url: https://storage.lczero.org/files/networks-contrib/t1-512x15x8h-distilled-swa-3395000.pb.gz
        sha256: 1fdb1519e5b02e03f1d9201ec8eb95f640e32cc6459a4f14c0eab6890dc097e8

  - name: tcl # latest stable tcl, required for scid
    subdir: unix
    post-install:
      - chmod 755 /app/lib/libtcl*.so
    cleanup:
      - /bin
      - /lib/pkgconfig
      - /man
    sources:
      - type: git
        url: https://github.com/tcltk/tcl.git
        tag: core-8-6-17
        commit: 433df5b20a8bd6957c3bda981c83d65202eb7de7

  - name: tk # latest stable tk, required for scid
    subdir: unix
    make-args:
      - binaries
      - libraries
    make-install-args:
      - install-binaries
      - install-libraries
    post-install:
      - chmod 755 /app/lib/libtk*.so
    cleanup:
      - /bin
      - /lib/pkgconfig
      - /man
    sources:
      - type: git
        url: https://github.com/tcltk/tk.git
        tag: core-8-6-17
        commit: afdf30259d05840a4e513bae638955902322d1ec

  - name: scid # main app
    buildsystem: cmake-ninja
    post-install:
      - ln -s /app/scid/scid /app/bin/
      - install -Dma+r flatpak/io.github.benini.scid.svg /app/share/icons/hicolor/scalable/apps/io.github.benini.scid.svg
      - install -Dma+r flatpak/io.github.benini.scid.desktop /app/share/applications/io.github.benini.scid.desktop
      - install -Dma+r flatpak/io.github.benini.scid.appdata.xml /app/share/appdata/io.github.benini.scid.appdata.xml
    sources:
      - type: git
        url: https://github.com/benini/scid.git
        commit: c1c3006d5c304a32b2784b64e6e73070f91a97e7

  - name: players_data
    buildsystem: simple
    build-commands:
      - cp -r * /app/scid
    sources:
      - type: archive
        url: https://prdownloads.sourceforge.net/scid/players-5.1.zip
        sha256: 29f31da6baa57038193deff80a6d0f886de0883dc8b991f1b80b2f81b108cf35

  - name: ttk_themes
    buildsystem: simple
    build-commands:
      - mv tclthemes /app/scid/themes
    sources:
      - type: git
        url: https://github.com/ukscid/ttk-themes-scid.git
        tag: V1.0
        commit: f6b8f2565e76ffaefc5a5191b0c1494fa73104d7
